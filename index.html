<!DOCTYPE html>
<html lang="de">
<head>
    <script src="redirect.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexusFM Pro</title>

    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1ViHwf320k1R7PADP_7KqMOJKNnaUMVIC">
    <link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/d/1ViHwf320k1R7PADP_7KqMOJKNnaUMVIC">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="NexusFM">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root { 
            --y: #f1c40f; 
            --y-glow: rgba(241, 196, 15, 0.5);
            --b: #000000; 
            --glass: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
            --text-muted: #aaaaaa;
            --danger: #e74c3c;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; 
            background: var(--b);
            color: var(--text);
            margin: 0; padding-bottom: 130px; 
            overflow-x: hidden; 
            min-height: 100vh;
            overscroll-behavior-y: none;
            transition: background 1s ease;
        }

        /* ANIMIERTER HINTERGRUND */
        .bg-anim {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: radial-gradient(circle at 10% 20%, var(--y-glow) 0%, #000 40%),
                        radial-gradient(circle at 90% 80%, rgba(0,0,0,0.5) 0%, #000 40%);
            animation: bgShift 10s ease-in-out infinite alternate;
            opacity: 0.4;
        }
        @keyframes bgShift { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        /* TICKER */
        .t-wrap {
            position: sticky; top: 0; z-index: 2500;
            background: var(--y); color: #000;
            height: 32px; display: flex; align-items: center;
            box-shadow: 0 5px 20px rgba(241, 196, 15, 0.2);
        }
        .t-l { background: #000; color: var(--y); padding: 0 12px; font-weight: 900; font-size: 10px; z-index: 30; height: 100%; display: flex; align-items: center; text-transform: uppercase; letter-spacing: 1px; }
        .t-container { flex: 1; overflow: hidden; white-space: nowrap; position: relative; height: 100%; background: var(--y); }
        .t-c { display: inline-block; padding-left: 100%; font-size: 12px; font-weight: 800; line-height: 32px; animation: marquee 40s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* HEADER */
        header { 
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            position: relative; z-index: 10;
        }
        .menu-btn { font-size: 24px; color: var(--y); cursor: pointer; filter: drop-shadow(0 0 8px var(--y-glow)); transition: 0.2s; }
        .header-logo { height: 60px; max-width: 200px; object-fit: contain; }

        /* SIDEBAR */
        #sidebar {
            position: fixed; top: 0; left: 0; width: 280px; height: 100%;
            background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 5000; transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); 
            padding: 60px 20px; border-right: 1px solid var(--glass-border);
        }
        #sidebar.open { transform: translateX(0); }
        .side-item { 
            padding: 15px; font-size: 15px; font-weight: 600; color: var(--text-muted); 
            border-radius: 12px; margin-bottom: 5px; cursor: pointer; 
            display: flex; align-items: center; gap: 12px; transition: 0.2s; 
        }
        .side-item:hover, .side-item.active { background: rgba(241, 196, 15, 0.1); color: var(--y); }

        /* PAGES */
        .page { display: none; padding: 0 15px; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* SEARCH & FILTERS */
        .s-box { padding: 10px 0 10px; position: sticky; top: 32px; z-index: 20; background: var(--b); }
        .s-in { 
            display: flex; background: var(--glass); border-radius: 16px; padding: 6px; 
            border: 1px solid var(--glass-border); align-items: center;
        }
        input { flex: 1; background: 0; border: 0; color: #fff; padding: 12px; outline: 0; font-size: 16px; }
        .s-btn { background: var(--y); border: 0; width: 44px; height: 44px; border-radius: 12px; color: #000; cursor: pointer; }

        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0 20px; scrollbar-width: none; }
        .filter-bar::-webkit-scrollbar { display: none; }
        .f-tag { background: rgba(255,255,255,0.05); padding: 6px 15px; border-radius: 20px; font-size: 12px; white-space: nowrap; border: 1px solid var(--glass-border); cursor: pointer; }
        .f-tag.active { background: var(--y); color: #000; border-color: var(--y); }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding-bottom: 20px; }
        .card { 
            background: var(--glass); border-radius: 18px; padding: 15px 8px; 
            text-align: center; border: 1px solid var(--glass-border); 
            position: relative; transition: 0.2s;
        }
        .card.playing { border-color: var(--y); box-shadow: 0 0 15px var(--y-glow); }
        .card img { width: 50px; height: 50px; object-fit: contain; border-radius: 8px; margin-bottom: 8px; pointer-events: none; }
        .card span { font-size: 11px; font-weight: 700; display: block; height: 2.6em; overflow: hidden; pointer-events: none; }
        .fav-icon { position: absolute; top: 8px; right: 8px; font-size: 14px; color: rgba(255,255,255,0.2); z-index: 5; }
        .fav-icon.active { color: var(--y); }

        /* RECENTLY PLAYED */
        .recent-section { margin-bottom: 25px; }
        .recent-h { font-size: 14px; font-weight: 800; color: var(--y); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }

        /* PLAYERS */
        .player {
            position: fixed; bottom: 20px; left: 15px; right: 15px;
            background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 12px 18px; z-index: 4000; display: flex; align-items: center; justify-content: space-between;
            transform: translateY(150%); transition: 0.4s;
        }
        .player.visible { transform: translateY(0); }
        .p-left { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; }
        .p-img { width: 44px; height: 44px; border-radius: 10px; background: #000; }
        .p-info h4 { margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-title { font-size: 11px; color: var(--y); }
        .p-btn { background: var(--y); border: 0; width: 42px; height: 42px; border-radius: 50%; font-size: 16px; cursor: pointer; }

        /* FULL PLAYER */
        #full-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            background: linear-gradient(to bottom, #111, #000); 
            z-index: 9000; display: flex; flex-direction: column;
            transform: translateY(100%); transition: 0.5s cubic-bezier(0.4, 0, 0, 1);
        }
        #full-player.active { transform: translateY(0); }
        .fp-header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .fp-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .fp-img { width: 70vw; height: 70vw; max-width: 300px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin-bottom: 30px; transition: 0.3s; }
        
        /* Advanced Visualizer */
        #canvas-viz { width: 100%; height: 100px; margin-bottom: 20px; }

        .controls-area { padding: 30px 20px 50px; display: flex; flex-direction: column; align-items: center; }
        .big-play { width: 80px; height: 80px; border-radius: 50%; background: var(--y); font-size: 30px; border: 0; margin: 0 30px; }
        .rec-indicator { color: var(--danger); font-size: 12px; font-weight: bold; margin-bottom: 10px; display: none; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* THEMES */
        body.theme-midnight { --y: #3498db; --y-glow: rgba(52, 152, 219, 0.5); --b: #0b0e14; }
        body.theme-cyberpunk { --y: #00ff00; --y-glow: rgba(0, 255, 0, 0.5); --b: #2b002b; }
        body.theme-highcontrast { --y: #ffffff; --y-glow: rgba(255,255,255,0.5); --b: #000000; }

        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 4500; display: none; backdrop-filter: blur(4px); }
        
        /* Bitrate & Tools */
        .info-pill { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 8px; font-size: 10px; color: #888; margin-top: 10px; }
    </style>
</head>
<body id="main-body">

    <div class="bg-anim"></div>

    <div class="t-wrap">
        <div class="t-l"><i class="fas fa-bolt"></i> NEWS</div>
        <div class="t-container"><div class="t-c" id="ticker-content">+++ NEXUSFM PRO +++</div></div>
    </div>

    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="sidebar">
        <h2 style="color:var(--y);"><i class="fas fa-broadcast-tower"></i> NEXUS</h2>
        <div class="side-item active" onclick="showPage('radio')"><i class="fas fa-home"></i> Startseite</div>
        <div class="side-item" onclick="showPage('favorites')"><i class="fas fa-heart"></i> Favoriten</div>
        <div class="side-item" onclick="showPage('rcs')"><i class="fas fa-newspaper"></i> Nachrichten</div>
        <div class="side-item" onclick="showPage('settings')"><i class="fas fa-cog"></i> Einstellungen</div>
        <div class="side-item" onclick="showPage('about')"><i class="fas fa-info-circle"></i> Über uns</div>
    </div>

    <header>
        <i class="fas fa-bars menu-btn" onclick="toggleMenu()"></i>
        <img src="https://lh3.googleusercontent.com/d/1l5YvIoAXCWoAPNF7gD7ZAZ_0Bh3H8wvn" class="header-logo" alt="Logo">
    </header>

    <div id="page-radio" class="page active">
        <div class="s-box">
            <div class="s-in">
                <input type="text" id="sin" placeholder="Sender suchen..." onkeydown="if(event.key==='Enter') search()">
                <button class="s-btn" onclick="search()"><i class="fas fa-search"></i></button>
            </div>
            <div class="filter-bar">
                <div class="f-tag active" onclick="setCountry('DE', this)">Deutschland</div>
                <div class="f-tag" onclick="setCountry('AT', this)">Österreich</div>
                <div class="f-tag" onclick="setCountry('CH', this)">Schweiz</div>
                <div class="f-tag" onclick="setCountry('GB', this)">UK</div>
                <div class="f-tag" onclick="setCountry('US', this)">USA</div>
            </div>
            <div class="filter-bar" style="padding-top:0;">
                <div class="f-tag" onclick="searchTag('80s')">#80s</div>
                <div class="f-tag" onclick="searchTag('90s')">#90s</div>
                <div class="f-tag" onclick="searchTag('Rock')">#Rock</div>
                <div class="f-tag" onclick="searchTag('Pop')">#Pop</div>
                <div class="f-tag" onclick="searchTag('Techno')">#Techno</div>
                <div class="f-tag" onclick="searchTag('Lofi')">#Lofi</div>
            </div>
        </div>

        <div class="recent-section" id="recent-container" style="display:none;">
            <div class="recent-h">Zuletzt gehört</div>
            <div class="grid" id="recent-grid"></div>
        </div>

        <div class="grid" id="g"></div>
    </div>

    <div id="page-favorites" class="page">
        <h2 style="color:var(--y);">Favoriten (Sortierbar)</h2>
        <div class="grid" id="fav-grid"></div>
    </div>

    <div id="page-settings" class="page">
        <h2 style="color:var(--y);">Einstellungen</h2>
        
        <div style="background:var(--glass); padding:20px; border-radius:15px; margin-bottom:15px;">
            <h3>Design-Profile</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="s-btn" style="width:100%;" onclick="setTheme('default')">Nexus Gold</button>
                <button class="s-btn" style="width:100%; background:#3498db;" onclick="setTheme('midnight')">Midnight Blue</button>
                <button class="s-btn" style="width:100%; background:#00ff00;" onclick="setTheme('cyberpunk')">Cyberpunk</button>
                <button class="s-btn" style="width:100%; background:#fff;" onclick="setTheme('highcontrast')">High Contrast</button>
            </div>
        </div>

        <div style="background:var(--glass); padding:20px; border-radius:15px;">
            <h3>Backup & Restore</h3>
            <p style="font-size:12px; color:var(--text-muted);">Exportiere deine Favoriten als JSON-Datei.</p>
            <button class="s-btn" style="width:100%; margin-bottom:10px;" onclick="exportData()"><i class="fas fa-download"></i> Backup exportieren</button>
            <input type="file" id="importFile" style="display:none;" onchange="importData(event)">
            <button class="s-btn" style="width:100%; background:#444; color:#fff;" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Backup importieren</button>
        </div>
    </div>

    <div id="page-rcs" class="page">
        <h2 style="color:var(--y);">Nachrichten</h2>
        <div id="news-feed"></div>
    </div>

    <div id="page-about" class="page">
        <h2 style="color:var(--y);">Über NexusFM Pro</h2>
        <p>Version 2.0 - 2026</p>
    </div>

    <div class="player" id="mini-player" onclick="openFull()">
        <div class="p-left">
            <img id="pi" src="https://lh3.googleusercontent.com/d/1l5YvIoAXCWoAPNF7gD7ZAZ_0Bh3H8wvn" class="p-img">
            <div class="p-info">
                <h4 id="pn">NexusFM</h4>
                <div class="track-title" id="track-info">Bereit</div>
            </div>
        </div>
        <button class="p-btn" onclick="event.stopPropagation(); toggle();"><i class="fas fa-play" id="pt"></i></button>
    </div>

    <div id="full-player">
        <div class="fp-header">
            <i class="fas fa-chevron-down" style="font-size:24px;" onclick="closeFull()"></i>
            <span id="bitrate-info" style="font-size:10px; opacity:0.5;">- kbps</span>
            <i class="fas fa-random" onclick="playRandom()"></i>
        </div>
        <div class="fp-content">
            <div id="rec-status" class="rec-indicator">● RECORDING</div>
            <img id="f-img" src="https://lh3.googleusercontent.com/d/1l5YvIoAXCWoAPNF7gD7ZAZ_0Bh3H8wvn" class="fp-img" ondblclick="toggleMute()">
            <h2 id="f-name" style="margin:0;">Sender wählen</h2>
            <div id="f-track" style="color:var(--y); margin-bottom:20px;">Bereit</div>
            
            <canvas id="canvas-viz"></canvas>

            <div class="info-pill" id="tech-info">Auto Quality</div>
        </div>
        <div class="controls-area">
            <div style="display:flex; align-items:center; margin-bottom:30px;">
                <i class="fas fa-circle" id="rec-btn" style="font-size:24px; cursor:pointer;" onclick="toggleRecord()"></i>
                <button class="big-play" onclick="toggle()"><i class="fas fa-play" id="pt-f"></i></button>
                <i class="fas fa-heart" id="fp-fav" style="font-size:24px; cursor:pointer;" onclick="toggleCurrentFav()"></i>
            </div>
            <input type="range" min="0" max="1" step="0.01" value="1" style="width:80%;" oninput="setVolume(this.value)">
        </div>
    </div>

    <audio id="a" crossorigin="anonymous"></audio>

    <script>
        const a = document.getElementById('a');
        const colorThief = new ColorThief();
        let currentStation = null;
        let favorites = JSON.parse(localStorage.getItem('nexus_favs')) || [];
        let recentlyPlayed = JSON.parse(localStorage.getItem('nexus_recent')) || [];
        let currentCountry = "DE";
        
        // Recording
        let mediaRecorder;
        let recordedChunks = [];

        // Audio Context & Visualizer
        let audioCtx, analyser, source, canvas, ctx, bufferLength, dataArray;

        const els = {
            g: document.getElementById('g'),
            favG: document.getElementById('fav-grid'),
            mini: document.getElementById('mini-player'),
            full: document.getElementById('full-player'),
            pn: document.getElementById('pn'), fn: document.getElementById('f-name'),
            pi: document.getElementById('pi'), fi: document.getElementById('f-img'),
            ti: document.getElementById('track-info'), ft: document.getElementById('f-track'),
            pt: document.getElementById('pt'), ptf: document.getElementById('pt-f'),
            fpFav: document.getElementById('fp-fav'), sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('overlay')
        };

        // --- CORE FUNCTIONS ---

        async function load(q = "", country = "DE") {
            els.g.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;">Lade...</div>';
            let url = `https://de1.api.radio-browser.info/json/stations/bycountrycodeexact/${country}?limit=51&order=clickcount&reverse=true`;
            if(q) url = `https://de1.api.radio-browser.info/json/stations/byname/${encodeURIComponent(q)}?limit=51`;

            try {
                const r = await fetch(url);
                const d = await r.json();
                els.g.innerHTML = "";
                d.forEach(s => els.g.appendChild(createCard(s)));
            } catch(e) { els.g.innerHTML = "Fehler."; }
        }

        function createCard(s) {
            const div = document.createElement('div');
            const isFav = favorites.some(f => f.stationuuid === s.stationuuid);
            div.className = 'card';
            div.dataset.uuid = s.stationuuid;
            div.innerHTML = `
                <i class="fas fa-heart fav-icon ${isFav ? 'active' : ''}" onclick="event.stopPropagation(); toggleFav('${s.stationuuid}', this)"></i>
                <img src="${s.favicon || 'https://lh3.googleusercontent.com/d/1l5YvIoAXCWoAPNF7gD7ZAZ_0Bh3H8wvn'}" onerror="this.src='https://lh3.googleusercontent.com/d/1l5YvIoAXCWoAPNF7gD7ZAZ_0Bh3H8wvn'">
                <span>${s.name}</span>
            `;
            div.onclick = () => playStation(s);
            div.dataset.station = JSON.stringify(s);
            return div;
        }

        function playStation(s) {
            currentStation = s;
            a.src = s.url_resolved;
            a.play();
            
            els.mini.classList.add('visible');
            els.pn.innerText = els.fn.innerText = s.name;
            els.pi.src = els.fi.src = s.favicon || 'https://lh3.googleusercontent.com/d/1l5YvIoAXCWoAPNF7gD7ZAZ_0Bh3H8wvn';
            document.getElementById('bitrate-info').innerText = (s.bitrate || '128') + " kbps";
            
            updateRecent(s);
            initVisualizer();
            updateFavIconInFullPlayer(s.stationuuid);
            
            // Dynamischer Hintergrund
            els.fi.onload = () => {
                try {
                    const rgb = colorThief.getColor(els.fi);
                    document.documentElement.style.setProperty('--y', `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`);
                    document.documentElement.style.setProperty('--y-glow', `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0.4)`);
                } catch(e) {}
            };
        }

        // --- FEATURES FROM IMAGE ---

        // 1. Drag-and-Drop Favoriten
        const sortable = new Sortable(els.favG, {
            animation: 150,
            onEnd: function() {
                const newFavs = [];
                els.favG.querySelectorAll('.card').forEach(card => {
                    newFavs.push(JSON.parse(card.dataset.station));
                });
                favorites = newFavs;
                localStorage.setItem('nexus_favs', JSON.stringify(favorites));
            }
        });

        // 2. Zuletzt gehört (Recently Played)
        function updateRecent(s) {
            recentlyPlayed = recentlyPlayed.filter(x => x.stationuuid !== s.stationuuid);
            recentlyPlayed.unshift(s);
            if(recentlyPlayed.length > 10) recentlyPlayed.pop();
            localStorage.setItem('nexus_recent', JSON.stringify(recentlyPlayed));
            renderRecent();
        }

        function renderRecent() {
            const container = document.getElementById('recent-container');
            const grid = document.getElementById('recent-grid');
            if(recentlyPlayed.length > 0) {
                container.style.display = 'block';
                grid.innerHTML = "";
                recentlyPlayed.forEach(s => grid.appendChild(createCard(s)));
            }
        }

        // 3. Record Funktion
        async function toggleRecord() {
            const btn = document.getElementById('rec-btn');
            const status = document.getElementById('rec-status');

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                btn.style.color = "#fff";
                status.style.display = "none";
            } else {
                if (!audioCtx) initVisualizer();
                const dest = audioCtx.createMediaStreamDestination();
                source.connect(dest);
                
                mediaRecorder = new MediaRecorder(dest.stream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/mp3' });
                    const url = URL.createObjectURL(blob);
                    const aLink = document.createElement('a');
                    aLink.href = url;
                    aLink.download = `${currentStation.name}_aufnahme.mp3`;
                    aLink.click();
                };
                
                mediaRecorder.start();
                btn.style.color = "var(--danger)";
                status.style.display = "block";
            }
        }

        // 4. Advanced Canvas Visualizer
        function initVisualizer() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            source = audioCtx.createMediaElementSource(a);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            
            analyser.fftSize = 64;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            canvas = document.getElementById('canvas-viz');
            ctx = canvas.getContext('2d');
            draw();
        }

        function draw() {
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / bufferLength) * 2.5;
            let x = 0;
            for(let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 2;
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--y');
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 2;
            }
        }

        // 5. Backup & Restore
        function exportData() {
            const data = JSON.stringify(favorites);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nexusfm_backup.json';
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                favorites = JSON.parse(e.target.result);
                localStorage.setItem('nexus_favs', JSON.stringify(favorites));
                alert("Import erfolgreich!");
                loadFavs();
            };
            reader.readAsText(file);
        }

        // --- HELPERS ---

        function toggleMenu() {
            els.sidebar.classList.toggle('open');
            els.overlay.style.display = els.sidebar.classList.contains('open') ? 'block' : 'none';
        }

        function showPage(pid) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pid).classList.add('active');
            if(pid === 'favorites') loadFavs();
            toggleMenu();
        }

        function loadFavs() {
            els.favG.innerHTML = "";
            favorites.forEach(s => els.favG.appendChild(createCard(s)));
        }

        function toggle() {
            if(a.paused) { a.play(); updateIcons(true); }
            else { a.pause(); updateIcons(false); }
        }

        function updateIcons(p) {
            els.pt.className = els.ptf.className = p ? "fas fa-pause" : "fas fa-play";
        }

        function setCountry(c, btn) {
            currentCountry = c;
            document.querySelectorAll('.f-tag').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            load("", c);
        }

        function searchTag(t) { load(t, currentCountry); }
        function search() { load(document.getElementById('sin').value, currentCountry); }
        function openFull() { els.full.classList.add('active'); }
        function closeFull() { els.full.classList.remove('active'); }
        function setVolume(v) { a.volume = v; }
        function toggleMute() { a.muted = !a.muted; }
        function setTheme(t) {
            document.body.className = t === 'default' ? '' : 'theme-' + t;
        }

        function toggleFav(uuid, icon) {
            const card = icon.closest('.card');
            const station = JSON.parse(card.dataset.station);
            const idx = favorites.findIndex(f => f.stationuuid === uuid);
            if(idx > -1) favorites.splice(idx, 1);
            else favorites.push(station);
            localStorage.setItem('nexus_favs', JSON.stringify(favorites));
            icon.classList.toggle('active');
        }

        function toggleCurrentFav() {
            if(!currentStation) return;
            const idx = favorites.findIndex(f => f.stationuuid === currentStation.stationuuid);
            if(idx > -1) favorites.splice(idx, 1);
            else favorites.push(currentStation);
            localStorage.setItem('nexus_favs', JSON.stringify(favorites));
            updateFavIconInFullPlayer(currentStation.stationuuid);
        }

        function updateFavIconInFullPlayer(uuid) {
            const isFav = favorites.some(f => f.stationuuid === uuid);
            els.fpFav.style.color = isFav ? "var(--y)" : "#fff";
        }

        function playRandom() {
            const cards = els.g.querySelectorAll('.card');
            if(cards.length > 0) cards[Math.floor(Math.random()*cards.length)].click();
        }

        // Start
        load();
        renderRecent();
    </script>
</body>
</html>
