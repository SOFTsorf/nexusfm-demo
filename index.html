<!DOCTYPE html>
<html lang="de">
<head>
    <script src="redirect.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexusFM Pro</title>

    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1ViHwf320k1R7PADP_7KqMOJKNnaUMVIC">
    <link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/d/1ViHwf320k1R7PADP_7KqMOJKNnaUMVIC">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="NexusFM">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <style>
        :root { 
            --y: #f1c40f; 
            --y-glow: rgba(241, 196, 15, 0.5);
            --b: #000000; 
            --glass: rgba(20, 20, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
            --text-muted: #aaaaaa;
            --danger: #e74c3c;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; 
            background: var(--b);
            color: var(--text);
            margin: 0; padding-bottom: 130px; 
            overflow-x: hidden; 
            min-height: 100vh;
            overscroll-behavior-y: none;
            transition: background 0.5s ease;
        }

        /* Themes */
        body.theme-cyberpunk { --y: #00ffcc; --y-glow: rgba(0, 255, 204, 0.5); }
        body.theme-midnight { --y: #3498db; --y-glow: rgba(52, 152, 219, 0.5); }
        body.theme-contrast { --y: #ffffff; --y-glow: rgba(255, 255, 255, 0.5); }

        .bg-anim {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: radial-gradient(circle at 10% 20%, rgba(30,30,0,0.5) 0%, #000 40%),
                        radial-gradient(circle at 90% 80%, rgba(30,20,0,0.5) 0%, #000 40%);
        }

        /* TICKER */
        .t-wrap {
            position: sticky; top: 0; z-index: 2500;
            background: var(--y); color: #000;
            height: 32px; display: flex; align-items: center;
        }
        .t-l { background: #000; color: var(--y); padding: 0 12px; font-weight: 900; font-size: 10px; z-index: 30; height: 100%; display: flex; align-items: center; text-transform: uppercase; }
        .t-container { flex: 1; overflow: hidden; white-space: nowrap; position: relative; height: 100%; background: var(--y); }
        .t-c { display: inline-block; padding-left: 100%; font-size: 12px; font-weight: 800; line-height: 32px; animation: marquee 40s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        header { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 10; }
        .menu-btn { font-size: 24px; color: var(--y); cursor: pointer; transition: 0.2s; }
        .header-logo { height: 50px; object-fit: contain; }

        /* SIDEBAR */
        #sidebar {
            position: fixed; top: 0; left: 0; width: 280px; height: 100%;
            background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(20px);
            z-index: 5000; transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); 
            padding: 60px 20px; border-right: 1px solid var(--glass-border);
        }
        #sidebar.open { transform: translateX(0); }
        .side-item { padding: 15px; font-size: 16px; color: var(--text-muted); border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 15px; }
        .side-item.active { background: rgba(241, 196, 15, 0.1); color: var(--y); }
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 4500; display:none; }

        /* RECENTLY PLAYED */
        .recent-bar { overflow-x: auto; display: flex; gap: 10px; padding: 10px 0; scrollbar-width: none; }
        .recent-bar::-webkit-scrollbar { display: none; }
        .recent-item { min-width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--glass-border); overflow: hidden; flex-shrink: 0; cursor: pointer; }
        .recent-item img { width: 100%; height: 100%; object-fit: cover; }

        /* GENRE BAR */
        .tag-bar { overflow-x: auto; display: flex; gap: 8px; padding: 10px 0 20px; scrollbar-width: none; }
        .tag { background: var(--glass); padding: 6px 15px; border-radius: 20px; font-size: 12px; border: 1px solid var(--glass-border); white-space: nowrap; cursor: pointer; }
        .tag.active { background: var(--y); color: #000; border-color: var(--y); }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding-bottom: 20px; }
        .card { 
            background: var(--glass); border-radius: 18px; padding: 15px 8px; 
            text-align: center; border: 1px solid var(--glass-border); 
            position: relative; transition: 0.25s;
        }
        .card.playing { border-color: var(--y); box-shadow: 0 0 15px var(--y-glow); }
        .card img { width: 50px; height: 50px; border-radius: 8px; margin-bottom: 8px; }
        .card span { font-size: 11px; font-weight: 700; height: 2.6em; overflow: hidden; display: block; }
        .fav-controls { position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column; gap: 5px; z-index: 5; }
        .fav-icon { color: rgba(255,255,255,0.3); font-size: 14px; cursor: pointer; }
        .fav-icon.active { color: var(--y); }
        .move-btn { color: #fff; font-size: 10px; background: rgba(0,0,0,0.5); padding: 4px; border-radius: 4px; }

        /* PLAYER */
        .player {
            position: fixed; bottom: 20px; left: 15px; right: 15px;
            background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 12px 18px; z-index: 4000; display: flex; align-items: center; justify-content: space-between;
            transform: translateY(150%); transition: transform 0.4s;
        }
        .player.visible { transform: translateY(0); }
        .p-left { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; }
        .p-img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .bitrate-badge { font-size: 9px; background: var(--y); color: #000; padding: 1px 4px; border-radius: 3px; font-weight: bold; margin-left: 5px; }

        /* FULL PLAYER & CANVAS */
        #full-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            background: #000; z-index: 9000; display: flex; flex-direction: column;
            transform: translateY(100%); transition: 0.5s; overflow: hidden;
        }
        #full-player.active { transform: translateY(0); }
        #wave-canvas { position: absolute; bottom: 150px; left: 0; width: 100%; height: 150px; pointer-events: none; opacity: 0.6; }

        .big-play { width: 70px; height: 70px; border-radius: 50%; background: var(--y); color: #000; border: none; font-size: 24px; cursor: pointer; }
        .record-btn.active { color: var(--danger); animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .page { display: none; padding: 0 15px; }
        .page.active { display: block; }

        /* OPT SECTIONS */
        .opt-section { margin-bottom: 20px; background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; }
        .sec-head { color: var(--y); font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 10px; }
        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .opt-btn { background: #222; color: #fff; border: 0; padding: 10px 15px; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .opt-btn:active { background: var(--y); color: #000; }

        #opt-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9500; display: none; align-items: flex-end; }
        .opt-box { width: 100%; background: #121212; border-radius: 25px 25px 0 0; padding: 25px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

    <div class="bg-anim" id="bg-anim"></div>

    <div class="t-wrap">
        <div class="t-l">NEWS</div>
        <div class="t-container"><div class="t-c" id="ticker-content">Lade Weltnachrichten...</div></div>
    </div>

    <div id="overlay" onclick="toggleMenu()"></div>
    <nav id="sidebar">
        <h2 style="color:var(--y); margin-bottom: 30px;">NEXUS PRO</h2>
        <div class="side-item active" onclick="showPage('radio')"><i class="fas fa-home"></i> Startseite</div>
        <div class="side-item" onclick="showPage('favorites')"><i class="fas fa-heart"></i> Favoriten</div>
        <div class="side-item" onclick="showPage('settings')"><i class="fas fa-cog"></i> Personalisierung</div>
        <div class="side-item" onclick="showPage('about')"><i class="fas fa-info-circle"></i> Info</div>
    </nav>

    <header>
        <i class="fas fa-bars menu-btn" onclick="toggleMenu()"></i>
        <img src="https://lh3.googleusercontent.com/d/1ViHwf320k1R7PADP_7KqMOJKNnaUMVIC" class="header-logo" alt="Nexus">
    </header>

    <div id="page-radio" class="page active">
        <div id="recently-played-section" style="display:none; margin-bottom:15px;">
            <small style="color:var(--text-muted); font-weight:bold;">ZULETZT GEHÃ–RT</small>
            <div class="recent-bar" id="recent-list"></div>
        </div>

        <div style="background:var(--glass); border-radius:15px; padding:5px; display:flex; margin-bottom:15px;">
            <input type="text" id="sin" placeholder="Sender, Genre..." style="flex:1; background:0; border:0; color:#fff; padding:10px;" onkeydown="if(event.key==='Enter') search()">
            <button onclick="search()" style="background:var(--y); border:0; width:40px; border-radius:10px;"><i class="fas fa-search"></i></button>
            <button onclick="playRandom()" style="background:#333; color:var(--y); border:0; width:40px; border-radius:10px; margin-left:5px;"><i class="fas fa-dice"></i></button>
        </div>

        <div class="tag-bar">
            <div class="tag" onclick="filterCountry('DE')">ðŸ‡©ðŸ‡ª Deutschland</div>
            <div class="tag" onclick="filterCountry('US')">ðŸ‡ºðŸ‡¸ USA</div>
            <div class="tag" onclick="filterCountry('GB')">ðŸ‡¬ðŸ‡§ UK</div>
            <div class="tag" onclick="filterCountry('FR')">ðŸ‡«ðŸ‡· Frankreich</div>
            <div class="tag" onclick="search('Rock')">ðŸŽ¸ Rock</div>
            <div class="tag" onclick="search('Pop')">ðŸŽ¤ Pop</div>
            <div class="tag" onclick="search('Lofi')">â˜• Lofi</div>
            <div class="tag" onclick="search('80s')">ðŸ•º 80s</div>
        </div>

        <div class="grid" id="g"></div>
    </div>

    <div id="page-favorites" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:var(--y);">Favoriten</h2>
            <div class="btn-row">
                <button class="opt-btn" onclick="exportData()"><i class="fas fa-download"></i> Backup</button>
                <label class="opt-btn"><i class="fas fa-upload"></i> Restore <input type="file" style="display:none" onchange="importData(this)"></label>
            </div>
        </div>
        <div class="grid" id="fav-grid"></div>
    </div>

    <div id="page-settings" class="page">
        <h2 style="color:var(--y);">Personalisierung</h2>
        <div class="opt-section">
            <div class="sec-head">Custom Themes</div>
            <div class="btn-row">
                <button class="opt-btn" onclick="setTheme('default')">Nexus Gold</button>
                <button class="opt-btn" onclick="setTheme('midnight')">Midnight Blue</button>
                <button class="opt-btn" onclick="setTheme('cyberpunk')">Cyberpunk</button>
                <button class="opt-btn" onclick="setTheme('contrast')">High Contrast</button>
            </div>
        </div>
        <div class="opt-section">
            <div class="sec-head">System</div>
            <div class="btn-row">
                <button class="opt-btn btn-danger" onclick="clearAllData()">Alle Daten lÃ¶schen</button>
            </div>
        </div>
    </div>

    <div class="player" id="mini-player" onclick="openFull()">
        <div class="p-left">
            <img id="pi" src="" class="p-img">
            <div style="overflow:hidden;">
                <div style="display:flex; align-items:center;">
                    <b id="pn" style="font-size:14px; white-space:nowrap;">NexusFM</b>
                    <span id="bitrate-info" class="bitrate-badge">... kbps</span>
                </div>
                <div id="track-info" style="font-size:11px; color:var(--y); white-space:nowrap;">Bereit</div>
            </div>
        </div>
        <button class="big-play" style="width:40px; height:40px; font-size:16px;" onclick="event.stopPropagation(); toggle();"><i class="fas fa-play" id="pt"></i></button>
    </div>

    <div id="full-player">
        <canvas id="wave-canvas"></canvas>
        <div style="padding:20px; display:flex; justify-content:space-between;">
            <i class="fas fa-chevron-down" onclick="closeFull()" style="font-size:24px;"></i>
            <i class="fas fa-ellipsis-v" onclick="openOpts()"></i>
        </div>

        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px;">
            <div id="fp-logo-wrap" style="position:relative;" onclick="toggleMuteGesture()">
                <img id="f-img" src="" style="width:250px; height:250px; border-radius:20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                <div id="mute-indicator" style="position:absolute; inset:0; background:rgba(0,0,0,0.6); border-radius:20px; display:none; align-items:center; justify-content:center;">
                    <i class="fas fa-volume-mute" style="font-size:50px; color:#fff;"></i>
                </div>
            </div>
            <h2 id="f-name" style="margin:20px 0 5px;">Sendername</h2>
            <div id="f-track" style="color:var(--y); font-weight:bold;">Track Info</div>
        </div>

        <div style="padding:40px 20px; background:linear-gradient(to top, #000, transparent);">
            <div style="display:flex; align-items:center; justify-content:center; gap:30px; margin-bottom:30px;">
                <i class="fas fa-microphone record-btn" id="rec-btn" onclick="toggleRecord()" style="font-size:20px;"></i>
                <button class="big-play" onclick="toggle()"><i class="fas fa-play" id="pt-f"></i></button>
                <i class="fas fa-heart" id="fp-fav" onclick="toggleCurrentFav()" style="font-size:20px;"></i>
            </div>
            <div style="display:flex; align-items:center; gap:15px; color:#666;">
                <i class="fas fa-volume-down"></i>
                <input type="range" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)" style="flex:1;">
                <i class="fas fa-volume-up"></i>
            </div>
        </div>
    </div>

    <div id="opt-overlay" onclick="closeOpts()">
        <div class="opt-box" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">Optionen</h3>
            <div class="opt-section">
                <div class="sec-head">Sleep Timer</div>
                <div class="btn-row">
                    <button class="opt-btn" onclick="setSleep(15)">15m</button>
                    <button class="opt-btn" onclick="setSleep(30)">30m</button>
                    <button class="opt-btn" onclick="setSleep(60)">60m</button>
                    <button class="opt-btn" onclick="cancelSleep()">Aus</button>
                </div>
            </div>
            <button class="opt-btn" style="width:100%;" onclick="closeOpts()">SchlieÃŸen</button>
        </div>
    </div>

    <audio id="a" crossorigin="anonymous"></audio>

    <script>
        const a = document.getElementById('a');
        const defaultLogo = "https://lh3.googleusercontent.com/d/1ViHwf320k1R7PADP_7KqMOJKNnaUMVIC";
        let currentStation = null;
        let favorites = JSON.parse(localStorage.getItem('nexus_favs')) || [];
        let recentlyPlayed = JSON.parse(localStorage.getItem('nexus_recent')) || [];
        let audioCtx, source, analyser, dataArray, canvasCtx, bufferLength;
        let mediaRecorder, recordedChunks = [];
        let isRecording = false;

        const colorThief = new ColorThief();

        // UI Elements
        const els = {
            g: document.getElementById('g'),
            favG: document.getElementById('fav-grid'),
            pi: document.getElementById('pi'), fi: document.getElementById('f-img'),
            pn: document.getElementById('pn'), fn: document.getElementById('f-name'),
            ti: document.getElementById('track-info'), ft: document.getElementById('f-track'),
            pt: document.getElementById('pt'), ptf: document.getElementById('pt-f'),
            mini: document.getElementById('mini-player'),
            full: document.getElementById('full-player'),
            recentList: document.getElementById('recent-list'),
            recentSection: document.getElementById('recently-played-section'),
            bitrate: document.getElementById('bitrate-info'),
            recBtn: document.getElementById('rec-btn'),
            canvas: document.getElementById('wave-canvas')
        };

        // INITIALISIERUNG
        function init() {
            load();
            updateRecentUI();
            fetchNews();
            document.body.className = localStorage.getItem('nexus_theme') || '';
        }

        // NAVIGATION
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').style.display = document.getElementById('sidebar').classList.contains('open') ? 'block' : 'none'; }
        
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            if(id === 'favorites') loadFavs();
            toggleMenu();
        }

        // RADIO ENGINE
        async function load(query = "", country = "DE") {
            els.g.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>Suche Sender...</p>";
            let url = `https://de1.api.radio-browser.info/json/stations/bycountrycodeexact/${country}?limit=50&order=clickcount&reverse=true`;
            if(query) url = `https://de1.api.radio-browser.info/json/stations/byname/${encodeURIComponent(query)}?limit=50`;

            try {
                const r = await fetch(url);
                const d = await r.json();
                els.g.innerHTML = "";
                d.forEach(s => els.g.appendChild(createCard(s)));
            } catch(e) { els.g.innerHTML = "Fehler beim Laden."; }
        }

        function createCard(s, isFavPage = false) {
            const div = document.createElement('div');
            div.className = 'card';
            const isFav = favorites.some(f => f.stationuuid === s.stationuuid);
            const logo = s.favicon || defaultLogo;
            
            div.innerHTML = `
                <div class="fav-controls">
                    <i class="fas fa-heart fav-icon ${isFav ? 'active' : ''}" onclick="event.stopPropagation(); toggleFav('${s.stationuuid}', this, ${JSON.stringify(s).replace(/"/g, '&quot;')})"></i>
                    ${isFavPage ? `
                        <i class="fas fa-chevron-up move-btn" onclick="event.stopPropagation(); moveFav('${s.stationuuid}', -1)"></i>
                        <i class="fas fa-chevron-down move-btn" onclick="event.stopPropagation(); moveFav('${s.stationuuid}', 1)"></i>
                    ` : ''}
                </div>
                <img src="${logo}" onerror="this.src='${defaultLogo}'">
                <span>${s.name}</span>
            `;
            div.onclick = () => playStation(s);
            return div;
        }

        function playStation(s) {
            currentStation = s;
            a.src = s.url_resolved;
            a.play().catch(e => console.log("Auto-Play blocked"));
            
            els.mini.classList.add('visible');
            els.pn.innerText = els.fn.innerText = s.name;
            els.pi.src = els.fi.src = s.favicon || defaultLogo;
            els.ti.innerText = els.ft.innerText = "Lade Stream...";
            els.bitrate.innerText = (s.bitrate || '???') + " kbps";

            addToRecent(s);
            initVisualizer();
            updateFavStatus();
            
            // Dynamische Hintergrundfarbe
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = s.favicon || defaultLogo;
            img.onload = () => {
                try {
                    const rgb = colorThief.getColor(img);
                    document.documentElement.style.setProperty('--y', `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`);
                } catch(e) {}
            };
        }

        // RECENTLY PLAYED
        function addToRecent(s) {
            recentlyPlayed = recentlyPlayed.filter(r => r.stationuuid !== s.stationuuid);
            recentlyPlayed.unshift(s);
            if(recentlyPlayed.length > 10) recentlyPlayed.pop();
            localStorage.setItem('nexus_recent', JSON.stringify(recentlyPlayed));
            updateRecentUI();
        }

        function updateRecentUI() {
            if(recentlyPlayed.length === 0) return;
            els.recentSection.style.display = 'block';
            els.recentList.innerHTML = recentlyPlayed.map(s => `
                <div class="recent-item" onclick="playStation(${JSON.stringify(s).replace(/"/g, '&quot;')})">
                    <img src="${s.favicon || defaultLogo}" title="${s.name}">
                </div>
            `).join('');
        }

        // VISUALIZER (Canvas)
        function initVisualizer() {
            if(audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            source = audioCtx.createMediaElementSource(a);
            analyser = audioCtx.createAnalyser();
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            
            analyser.fftSize = 256;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            canvasCtx = els.canvas.getContext('2d');
            
            draw();
        }

        function draw() {
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            canvasCtx.clearRect(0, 0, els.canvas.width, els.canvas.height);
            
            const barWidth = (els.canvas.width / bufferLength) * 2.5;
            let x = 0;
            for(let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 2;
                canvasCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--y');
                canvasCtx.fillRect(x, els.canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        // RECORDING
        function toggleRecord() {
            if(!isRecording) {
                const stream = a.captureStream ? a.captureStream() : a.mozCaptureStream();
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
                mediaRecorder.onstop = saveRecording;
                mediaRecorder.start();
                els.recBtn.classList.add('active');
                isRecording = true;
            } else {
                mediaRecorder.stop();
                els.recBtn.classList.remove('active');
                isRecording = false;
            }
        }

        function saveRecording() {
            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `NexusFM_Rec_${Date.now()}.webm`;
            link.click();
            recordedChunks = [];
        }

        // FAVORITEN SORTIERUNG & BACKUP
        function toggleFav(uuid, icon, station) {
            const idx = favorites.findIndex(f => f.stationuuid === uuid);
            if(idx > -1) favorites.splice(idx, 1);
            else favorites.push(station);
            localStorage.setItem('nexus_favs', JSON.stringify(favorites));
            icon.classList.toggle('active');
            if(document.getElementById('page-favorites').classList.contains('active')) loadFavs();
        }

        function moveFav(uuid, direction) {
            const idx = favorites.findIndex(f => f.stationuuid === uuid);
            if(idx === -1) return;
            const newIdx = idx + direction;
            if(newIdx >= 0 && newIdx < favorites.length) {
                const temp = favorites[idx];
                favorites[idx] = favorites[newIdx];
                favorites[newIdx] = temp;
                localStorage.setItem('nexus_favs', JSON.stringify(favorites));
                loadFavs();
            }
        }

        function loadFavs() {
            els.favG.innerHTML = favorites.length ? "" : "<p style='grid-column:1/-1; text-align:center;'>Noch keine Favoriten.</p>";
            favorites.forEach(s => els.favG.appendChild(createCard(s, true)));
        }

        function exportData() {
            const data = JSON.stringify({ favs: favorites, theme: localStorage.getItem('nexus_theme') });
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'nexus_backup.json'; a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                favorites = data.favs || [];
                localStorage.setItem('nexus_favs', JSON.stringify(favorites));
                alert("Daten erfolgreich importiert!");
                location.reload();
            };
            reader.readAsText(input.files[0]);
        }

        // GESTURE & HELPERS
        let lastTap = 0;
        function toggleMuteGesture() {
            const now = Date.now();
            if(now - lastTap < 300) { // Double Tap
                a.muted = !a.muted;
                document.getElementById('mute-indicator').style.display = a.muted ? 'flex' : 'none';
            }
            lastTap = now;
        }

        function playRandom() {
            const cards = document.querySelectorAll('.card');
            if(cards.length) cards[Math.floor(Math.random()*cards.length)].click();
        }

        function filterCountry(code) { load("", code); }
        function search(q = "") { if(q) document.getElementById('sin').value = q; load(document.getElementById('sin').value); }
        function setTheme(t) { 
            const theme = t === 'default' ? '' : 'theme-' + t;
            document.body.className = theme;
            localStorage.setItem('nexus_theme', theme);
        }

        function toggle() { 
            if(a.paused) { a.play(); updateIcons(true); } 
            else { a.pause(); updateIcons(false); } 
        }
        function updateIcons(play) { els.pt.className = els.ptf.className = play ? "fas fa-pause" : "fas fa-play"; }
        function setVolume(v) { a.volume = v; }
        function openFull() { els.full.classList.add('active'); }
        function closeFull() { els.full.classList.remove('active'); }
        function openOpts() { document.getElementById('opt-overlay').style.display = 'flex'; }
        function closeOpts() { document.getElementById('opt-overlay').style.display = 'none'; }

        async function fetchNews() {
            try {
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://www.tagesschau.de/infoservices/alle-meldungen-100~rss2.xml')}`);
                const data = await res.json();
                document.getElementById('ticker-content').textContent = `+++ ${data.items.slice(0, 5).map(i => i.title.toUpperCase()).join(' +++ ')} +++ `;
            } catch(e) {}
        }

        init();
    </script>
</body>
</html>
